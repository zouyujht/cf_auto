# 工作流的名称
name: Sync Single File from Upstream

# 工作流的触发条件
on:
  # 使用 schedule 来设置定时任务
  schedule:
    # cron 表达式，'0 16 * * *' 代表 UTC 时间的每天 16:00
    # 由于 GitHub Actions 使用 UTC 时间，UTC 16:00 相当于 GMT+8 (北京时间) 的 00:00
    - cron: '0 16 * * *'
  
  # 添加 workflow_dispatch 允许您在 Actions 页面手动点击按钮来触发此工作流
  # 方便您进行测试
  workflow_dispatch:

# 定义工作流中的任务 (jobs)
jobs:
  sync:
    # 指定任务运行的虚拟环境
    runs-on: ubuntu-latest

    # 定义任务中的步骤 (steps)
    steps:
      # 第一步：检出 (checkout) 您自己的仓库代码
      # 这是为了能将之后下载的文件推送到您的仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第二步：下载指定 URL 的文件并重命名
      - name: Download and Rename File
        # 使用 run 来执行 shell 命令
        # curl -o [保存的文件名] [文件URL]
        # -o: 表示将输出写入文件而不是标准输出
        # -L: 表示跟随重定向 (对于原始文件链接很重要)
        run: curl -o _work.js -L "https://github.com/zouyujht/cfauto/raw/main/%E5%B0%91%E5%B9%B4%E4%BD%A0%E7%9B%B8%E4%BF%A1%E5%85%89%E5%90%97"

      # 第三步：配置 Git 用户信息
      # 每次提交都需要一个用户名和邮箱
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 第四步：提交并推送文件到您的仓库
      - name: Commit and Push if changed
        run: |
          # 添加所有更改到暂存区 (这里主要是 _work.js 文件)
          git add _work.js
          # 检查是否有文件变动。"git diff --staged --quiet" 如果没有变动则退出码为0，有变动则为1
          # "||" 表示如果前一个命令失败 (即有变动)，则执行后面的命令
          git diff --staged --quiet || (git commit -m "chore: Auto sync _work.js from upstream" && git push)
          echo "Sync completed."
